<!DOCTYPE html>
<html>
<head>
    <title>Debug Onboarding Data Flow</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        button { margin: 5px; padding: 10px; }
        .result { margin: 10px 0; padding: 10px; background: #f5f5f5; }
        .success { background: #d4edda; }
        .error { background: #f8d7da; }
        pre { font-size: 12px; max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>Debug Onboarding Data Flow</h1>
    
    <div class="section">
        <h3>1. Check LocalStorage Keys</h3>
        <button onclick="checkAllStorage()">Check All Storage</button>
        <div id="storage-result" class="result"></div>
    </div>
    
    <div class="section">
        <h3>2. Test API Profile Endpoint</h3>
        <button onclick="testProfileAPI()">Test GET Profile API</button>
        <div id="api-result" class="result"></div>
    </div>
    
    <div class="section">
        <h3>3. Test Onboarding Service</h3>
        <button onclick="testOnboardingService()">Test Onboarding Service</button>
        <div id="service-result" class="result"></div>
    </div>
    
    <div class="section">
        <h3>4. Simulate Profile Save</h3>
        <button onclick="simulateProfileSave()">Simulate Save</button>
        <div id="simulate-result" class="result"></div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:3001/api/v1';

        function checkAllStorage() {
            const resultDiv = document.getElementById('storage-result');
            
            const allKeys = Object.keys(localStorage);
            let html = '<strong>All LocalStorage Keys:</strong><br>';
            
            allKeys.forEach(key => {
                const value = localStorage.getItem(key);
                const truncated = value && value.length > 100 ? value.substring(0, 100) + '...' : value;
                html += `<strong>${key}:</strong> ${truncated}<br>`;
            });
            
            // Check specific onboarding keys
            html += '<br><strong>Specific Onboarding Keys:</strong><br>';
            const onboardingKeys = [
                'onboarding_data',
                'mock_onboarding_demo_user',
                'onboarding_complete',
                'onboarding_current_step',
                'inchronicle_access_token',
                'user_id'
            ];
            
            onboardingKeys.forEach(key => {
                const value = localStorage.getItem(key);
                if (value) {
                    html += `✅ <strong>${key}:</strong> ${value.length} chars<br>`;
                } else {
                    html += `❌ <strong>${key}:</strong> not found<br>`;
                }
            });
            
            resultDiv.innerHTML = html;
        }

        async function testProfileAPI() {
            const resultDiv = document.getElementById('api-result');
            resultDiv.innerHTML = 'Testing API...';
            
            try {
                const token = localStorage.getItem('inchronicle_access_token');
                
                if (!token) {
                    resultDiv.innerHTML = '❌ No auth token found';
                    resultDiv.className = 'result error';
                    return;
                }
                
                const response = await fetch(`${API_BASE_URL}/users/profile/me`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                console.log('API Response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('API Response data:', data);
                    resultDiv.innerHTML = `✅ API Success:<br><pre>${JSON.stringify(data, null, 2)}</pre>`;
                    resultDiv.className = 'result success';
                } else {
                    const errorText = await response.text();
                    console.error('API Error:', errorText);
                    resultDiv.innerHTML = `❌ API Error (${response.status}):<br>${errorText}`;
                    resultDiv.className = 'result error';
                }
                
            } catch (error) {
                console.error('API Request failed:', error);
                resultDiv.innerHTML = `❌ Request failed: ${error.message}`;
                resultDiv.className = 'result error';
            }
        }

        async function testOnboardingService() {
            const resultDiv = document.getElementById('service-result');
            resultDiv.innerHTML = 'Testing onboarding service...';
            
            try {
                // Simulate what the onboarding service does
                const token = localStorage.getItem('inchronicle_access_token');
                
                if (!token) {
                    resultDiv.innerHTML = '❌ No auth token - checking localStorage fallback';
                    
                    // Check localStorage keys
                    const mockData = localStorage.getItem('mock_onboarding_demo_user');
                    const onboardingData = localStorage.getItem('onboarding_data');
                    const userId = localStorage.getItem('user_id') || 'demo_user';
                    const userSpecific = localStorage.getItem(`mock_onboarding_${userId}`);
                    
                    let found = null;
                    if (mockData) found = { source: 'mock_onboarding_demo_user', data: JSON.parse(mockData) };
                    else if (onboardingData) found = { source: 'onboarding_data', data: JSON.parse(onboardingData) };
                    else if (userSpecific) found = { source: `mock_onboarding_${userId}`, data: JSON.parse(userSpecific) };
                    
                    if (found) {
                        resultDiv.innerHTML = `✅ Found data in ${found.source}:<br><pre>${JSON.stringify(found.data, null, 2)}</pre>`;
                        resultDiv.className = 'result success';
                    } else {
                        resultDiv.innerHTML = '❌ No onboarding data found anywhere';
                        resultDiv.className = 'result error';
                    }
                    return;
                }
                
                // Test API path
                const response = await fetch(`${API_BASE_URL}/users/profile/me`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const profileData = await response.json();
                    
                    // Check if profile has onboarding data
                    if (profileData.onboardingData) {
                        resultDiv.innerHTML = `✅ API has onboarding data:<br><pre>${JSON.stringify(profileData.onboardingData, null, 2)}</pre>`;
                        resultDiv.className = 'result success';
                    } else {
                        resultDiv.innerHTML = `⚠️ API profile exists but no onboardingData field:<br><pre>${JSON.stringify(profileData, null, 2)}</pre>`;
                        resultDiv.className = 'result error';
                    }
                } else {
                    resultDiv.innerHTML = `❌ API failed (${response.status})`;
                    resultDiv.className = 'result error';
                }
                
            } catch (error) {
                console.error('Service test failed:', error);
                resultDiv.innerHTML = `❌ Service test failed: ${error.message}`;
                resultDiv.className = 'result error';
            }
        }

        async function simulateProfileSave() {
            const resultDiv = document.getElementById('simulate-result');
            resultDiv.innerHTML = 'Simulating profile save...';
            
            try {
                const token = localStorage.getItem('inchronicle_access_token');
                
                if (!token) {
                    resultDiv.innerHTML = '❌ No auth token found';
                    resultDiv.className = 'result error';
                    return;
                }
                
                const testData = {
                    name: 'Test User Profile',
                    title: 'Test Engineer',
                    company: 'Test Company',
                    location: 'Test Location',
                    onboardingData: {
                        fullName: 'Test User Profile',
                        currentTitle: 'Test Engineer',
                        currentCompany: 'Test Company',
                        location: 'Test Location',
                        industry: 'Technology',
                        yearsOfExperience: 5,
                        profileImageUrl: '',
                        professionalSummary: 'Test summary',
                        specializations: ['Testing'],
                        careerHighlights: 'Test achievements',
                        skills: [],
                        topSkills: ['Testing'],
                        workExperiences: [],
                        education: [],
                        certifications: [],
                        careerGoals: ['Test goal'],
                        professionalInterests: ['Test interest']
                    }
                };
                
                const response = await fetch(`${API_BASE_URL}/users/profile`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(testData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    resultDiv.innerHTML = `✅ Save successful:<br><pre>${JSON.stringify(result, null, 2)}</pre>`;
                    resultDiv.className = 'result success';
                } else {
                    const errorText = await response.text();
                    resultDiv.innerHTML = `❌ Save failed (${response.status}):<br>${errorText}`;
                    resultDiv.className = 'result error';
                }
                
            } catch (error) {
                console.error('Simulate save failed:', error);
                resultDiv.innerHTML = `❌ Simulate save failed: ${error.message}`;
                resultDiv.className = 'result error';
            }
        }

        // Auto-run checks on load
        window.onload = function() {
            checkAllStorage();
        };
    </script>
</body>
</html>
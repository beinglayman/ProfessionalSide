#!/usr/bin/expect -f

# Set timeout for AI responses (can be slow)
set timeout 120

# Start the CLI
spawn npx ts-node src/cli/story-coach/index.ts coach-generate src/cli/story-coach/test-data/migration-entry.json --output-dir src/cli/story-coach/test-output/interactive-migration

# Answer 1: The moment you realized something was wrong (DIG question)
expect {
    "You:" {
        send "It was 2:17am on a Tuesday - I remember because my phone screen burned into my half-asleep eyes. I'd gotten 6 alerts in 10 seconds. Sarah from platform had already pinged Slack: 'checkout is completely frozen, customers can't complete purchases.' My stomach dropped. This was two weeks before Black Friday - our biggest launch. Every minute down was potentially 50K dollars in lost sales. I grabbed my laptop and didn't even wait for it to fully boot before I was typing.\r"
        exp_continue
    }
    timeout {
        puts "Timeout waiting for first question"
        exit 1
    }
}

# Answer 2: Follow-up or next question (usually about people/decisions)
expect {
    "You:" {
        send "I made the call at 2:43am to implement a distributed lock using Redis rather than roll back to the monolith. Dev, our senior contractor who knew the legacy system inside out, pushed back hard. He said 'we should just roll back, this is too risky.' But I knew a rollback would take 72 hours minimum and we'd lose 4 months of migration progress. I told the team: 'If this doesn't work, it's on me. I'm making the call.' Marcus from the database team had the Redis lock deployed by 4:17am.\r"
        exp_continue
    }
    timeout {
        puts "Timeout waiting for second question"
        exit 1
    }
}

# Answer 3: The obstacle/what made it hard
expect {
    "You:" {
        send "The root cause was a race condition between our new order service and the legacy inventory system. When we'd carved out the order service three weeks earlier, we hadn't accounted for a specific edge case - when two orders for the same limited-stock item hit within 50 milliseconds, both services thought inventory was available. The legacy system used pessimistic locking, but our new service assumed eventual consistency. It took us 3 hours just to reproduce it locally because it only happened under load.\r"
        exp_continue
    }
    timeout {
        puts "Timeout waiting for third question"
        exit 1
    }
}

# Answer 4: The counterfactual (what would have happened)
expect {
    "You:" {
        send "If I had listened to Dev and rolled back, we would have missed our Q4 deadline completely. The business had already promised investors we'd have the microservices architecture live by January. More importantly, we would have lost the team's confidence - they'd been working 60-hour weeks for 4 months on this. And if we hadn't found the bug at 2am? Customers would have been double-charged on Black Friday. We estimated 500K dollars in potential refunds and the PR nightmare that comes with it. The Redis solution not only fixed the immediate issue but became our standard pattern for all cross-service inventory operations.\r"
        exp_continue
    }
    timeout {
        puts "Timeout waiting for fourth question"
        exit 1
    }
}

# Answer 5: The metric/quantified impact
expect {
    "You:" {
        send "We went from 2% service extraction to 78% within 6 months, touching all 500,000 lines of code in the monolith. Deployment time dropped from 4 hours to 12 minutes. Infrastructure costs fell 40% annually - about 180K dollars saved. The incident runbook I wrote that night is still required reading for new engineers 18 months later. But the number I'm proudest of: zero customer-facing incidents during the entire migration. Not one.\r"
        exp_continue
    }
    timeout {
        puts "Timeout waiting for fifth question"
        exit 1
    }
}

# Answer 6: The learning/growth
expect {
    "You:" {
        send "That 2am incident taught me that leadership under pressure isn't about having all the answers - it's about making the call when everyone's looking at you. Sarah messaged me the next morning: 'that was real leadership under fire.' That meant more than any metric. I learned that the best technical decisions often feel uncomfortable in the moment. If Dev had been right and the Redis fix had failed, my career could have taken a very different turn. But I trusted my understanding of the system and my team. That's the lesson I carry: own the decision, own the outcome.\r"
        exp_continue
    }
    timeout {
        puts "Timeout waiting for sixth question"
        exit 1
    }
}

# Wait for story generation to complete
expect {
    "All files saved" {
        puts "\n\nCoaching session and story generation complete!"
    }
    eof {
        puts "\nProcess finished"
    }
    timeout {
        puts "Timeout waiting for completion"
    }
}

# Give a moment for files to be written
sleep 2
